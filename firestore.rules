/**
 * @fileoverview Firestore Security Rules for Prompt Jeopardy.
 *
 * Core Philosophy:
 * This ruleset enforces a strict ownership model. Admins own games,
 * and contestants own their profiles and submissions. Authorization decisions
 * are based on the authenticated user's ID (`request.auth.uid`) matching
 * the expected owner ID in the Firestore document path or within the document data.
 *
 * Data Structure:
 * - /games/{gameId}: Stores game instances, with adminId indicating the owner.
 * - /games/{gameId}/rounds/{roundId}: Stores round data for games, accessible only to the game admin.
 * - /games/{gameId}/rounds/{roundId}/submissions/{submissionId}: Stores contestant submissions, accessible to the game admin and the submitting contestant.
 * - /contestants/{contestantId}: Stores contestant profiles, where contestantId matches the Firebase auth UID.
 * - /admins/{adminId}: Stores admin profiles, where adminId matches the Firebase auth UID.
 *
 * Key Security Decisions:
 * - No public listing of contestants or admins.
 * - Strict ownership checks for all write operations (create, update, delete).
 * - Read operations are generally restricted to owners, except where explicitly allowed (e.g., public read for games).
 * - No data schema validation is performed in this prototyping phase, except for essential authorization fields.
 *
 * Denormalization for Authorization:
 * - The `Game` document stores the `adminId`, which is used to authorize access to the game and its subcollections (Rounds, Submissions).
 * - The `Contestant` and `Admin` documents store their `id` which must match their `auth.uid`.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @returns {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user ID matches the provided user ID.
     * @param {string} userId - The user ID to compare against.
     * @returns {boolean} True if the authenticated user ID matches the provided user ID, false otherwise.
     * @example isOwner('someUserId') will return true if request.auth.uid == 'someUserId'.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user ID matches the provided user ID and the resource exists.
     * @param {string} userId - The user ID to compare against.
     * @returns {boolean} True if the authenticated user ID matches the provided user ID and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Rules for the /games/{gameId} collection.
     * @path /games/{gameId}
     * @allow (get, list): Any user can view game information.
     * @allow (create): Only an authenticated admin user can create a game, and the adminId must match their UID.
     * @allow (update, delete): Only the admin who created the game can update or delete it.
     * @deny (create): A non-authenticated user cannot create a game.
     * @deny (update, delete): A different authenticated user cannot update or delete the game.
     * @principle Enforces ownership for game management.
     */
    match /games/{gameId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.adminId == request.auth.uid;
      allow update, delete: if isExistingOwner(resource.data.adminId);
    }

    /**
     * @description Rules for the /games/{gameId}/rounds/{roundId} collection.
     * @path /games/{gameId}/rounds/{roundId}
     * @allow (get, list): Only the admin who created the game can read round information.
     * @allow (create): Only the admin who created the game can create rounds.
     * @allow (update, delete): Only the admin who created the game can update or delete rounds.
     * @deny (create, update, delete): A non-authenticated user cannot modify round data.
     * @deny (create, update, delete): A different authenticated user cannot modify round data.
     * @principle Enforces admin-only access for round management.
     */
    match /games/{gameId}/rounds/{roundId} {
      allow get, list: if isOwner(get(/databases/$(database)/documents/games/$(gameId)).data.adminId);
      allow create: if isOwner(get(/databases/$(database)/documents/games/$(gameId)).data.adminId);
      allow update, delete: if isExistingOwner(get(/databases/$(database)/documents/games/$(gameId)).data.adminId);
    }

    /**
     * @description Rules for the /games/{gameId}/rounds/{roundId}/submissions/{submissionId} collection.
     * @path /games/{gameId}/rounds/{roundId}/submissions/{submissionId}
     * @allow (get): Only the admin who created the game or the contestant who made the submission can read the submission.
     * @allow (list): Only the admin who created the game can list the submissions.
     * @allow (create): Only an authenticated contestant can create a submission, and the contestantId must match their UID.
     * @allow (update, delete): Only the admin who created the game can update or delete submissions. Contestants cannot modify submissions after creation.
     * @deny (create): A non-authenticated user cannot create a submission.
     * @deny (create): An authenticated user cannot create a submission for another user.
     * @deny (update, delete): A contestant cannot update or delete their own submission.
     * @principle Enforces ownership and admin control for submissions.
     */
    match /games/{gameId}/rounds/{roundId}/submissions/{submissionId} {
      allow get: if isOwner(get(/databases/$(database)/documents/games/$(gameId)).data.adminId) || isOwner(resource.data.contestantId);
      allow list: if isOwner(get(/databases/$(database)/documents/games/$(gameId)).data.adminId);
      allow create: if isSignedIn() && request.resource.data.contestantId == request.auth.uid;
      allow update, delete: if isExistingOwner(get(/databases/$(database)/documents/games/$(gameId)).data.adminId);
    }

    /**
     * @description Rules for the /contestants/{contestantId} collection.
     * @path /contestants/{contestantId}
     * @allow (get): Only the contestant themselves can read their profile.
     * @allow (list): Listing contestants is not allowed.
     * @allow (create): Only an authenticated user can create their own contestant profile, and the contestantId must match their UID.
     * @allow (update, delete): Only the contestant themselves can update or delete their profile.
     * @deny (create): A non-authenticated user cannot create a contestant profile.
     * @deny (create): An authenticated user cannot create a profile for another user.
     * @deny (update, delete): A different authenticated user cannot update or delete this profile.
     * @principle Enforces strict ownership for contestant profiles.
     */
    match /contestants/{contestantId} {
      allow get: if isOwner(contestantId);
      allow list: if false;
      allow create: if isOwner(contestantId);
      allow update, delete: if isExistingOwner(contestantId);
    }

    /**
     * @description Rules for the /admins/{adminId} collection.
     * @path /admins/{adminId}
     * @allow (get): Only the admin themselves can read their profile.
     * @allow (list): Listing admins is not allowed.
     * @allow (create): Only an authenticated user can create their own admin profile, and the adminId must match their UID.
     * @allow (update, delete): Only the admin themselves can update or delete their profile.
     * @deny (create): A non-authenticated user cannot create an admin profile.
     * @deny (create): An authenticated user cannot create a profile for another user.
     * @deny (update, delete): A different authenticated user cannot update or delete this profile.
     * @principle Enforces strict ownership for admin profiles.
     */
    match /admins/{adminId} {
      allow get: if isOwner(adminId);
      allow list: if false;
      allow create: if isOwner(adminId);
      allow update, delete: if isExistingOwner(adminId);
    }
  }
}